<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∏—Ç–≤–∞ –°—Ç—Ä–∞–Ω - TikTok Live –í–∏–¥–∂–µ—Ç</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º React –∏ Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Socket.IO –¥–ª—è —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: white;
        }

        .demo-background {
            background: linear-gradient(135deg, rgba(15,23,42,0.98) 0%, rgba(0,0,0,1) 100%);
        }

        .settings-bg {
            background-color: #0f172a;
            overflow-y: auto !important;
        }

        .progress-bar-transition { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .score-pulse { animation: pulse-score 0.4s ease-out; }

        @keyframes pulse-score {
            0% { transform: scale(1); color: #fff; }
            50% { transform: scale(1.3); color: #00ff88; text-shadow: 0 0 10px #00ff88; }
            100% { transform: scale(1); color: #fff; }
        }

        @keyframes winnerPop {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1.1; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        .winner-anim { animation: winnerPop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes explode-out {
            0% { transform: scale(1); opacity: 1; filter: brightness(1); }
            20% { transform: scale(1.1); filter: brightness(2) contrast(2); border-color: red; }
            100% { transform: scale(0.8) translateY(20px); opacity: 0; filter: blur(5px); }
        }
        .eliminating-anim { animation: explode-out 1.5s ease-in-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- –î–ê–ù–ù–´–ï SUPABASE ---
        const SUPABASE_URL = 'https://zagvyrqnayxdbqkcjqud.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_glnqsWdFcmaHOzUrfD5fGA_dt6xiB1f';

        // --- –î–û–°–¢–£–ü–ù–´–ï –°–¢–†–ê–ù–´ –î–õ–Ø –í–´–ë–û–†–ê –í –ù–ê–°–¢–†–û–ô–ö–ê–• ---
        const ALL_AVAILABLE_COUNTRIES = [
            { id: 'ru', name: '–†–æ—Å—Å–∏—è' }, { id: 'kz', name: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω' },
            { id: 'ua', name: '–£–∫—Ä–∞–∏–Ω–∞' }, { id: 'by', name: '–ë–µ–ª–∞—Ä—É—Å—å' },
            { id: 'uz', name: '–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω' }, { id: 'kg', name: '–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω' },
            { id: 'tj', name: '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω' }, { id: 'az', name: '–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω' },
            { id: 'am', name: '–ê—Ä–º–µ–Ω–∏—è' }, { id: 'md', name: '–ú–æ–ª–¥–æ–≤–∞' },
            { id: 'ge', name: '–ì—Ä—É–∑–∏—è' }, { id: 'tm', name: '–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω' }
        ];

        // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const DEFAULT_ROUNDS = 30;
        const DEFAULT_COUNTRIES = ALL_AVAILABLE_COUNTRIES.slice(0, 6);

        // --- –ù–ê–°–¢–†–û–ô–ö–ò –ê–î–ê–ü–¢–ò–í–ù–´–• –†–ê–ó–ú–ï–†–û–í ---
        const RANK_SIZES = [
            { h: 56, font: 'text-xl', scoreFont: 'text-2xl', flag: 'w-10 h-7', pad: 'p-3', border: 'border-green-500/50', bg: 'bg-black/80' },
            { h: 48, font: 'text-lg', scoreFont: 'text-xl',  flag: 'w-8 h-6',  pad: 'p-2.5', border: 'border-white/10', bg: 'bg-black/60' },
            { h: 42, font: 'text-base', scoreFont: 'text-lg',  flag: 'w-7 h-5',  pad: 'p-2', border: 'border-white/10', bg: 'bg-black/60' },
            { h: 36, font: 'text-sm', scoreFont: 'text-base',  flag: 'w-6 h-4',  pad: 'px-2 py-1.5', border: 'border-white/10', bg: 'bg-black/50' },
            { h: 32, font: 'text-xs', scoreFont: 'text-sm',  flag: 'w-5 h-3.5',pad: 'px-2 py-1', border: 'border-white/5', bg: 'bg-black/40' },
            { h: 28, font: 'text-[10px]', scoreFont: 'text-xs',  flag: 'w-4 h-3',  pad: 'px-2 py-1', border: 'border-white/5', bg: 'bg-black/40' }
        ];
        const LIST_GAP = 5;

        // –¢–∞–π–º–∏–Ω–≥–∏
        const ROUND_PLAY_SECONDS = 60;   
        const ROUND_ELIM_SECONDS = 4;    
        const ROUND_PAUSE_SECONDS = 10;  
        const ROUND_CELEB_SECONDS = 5;   
        const ROUND_BREAK_SECONDS = 60;  

        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        };

        // =========================================================================
        // 1. –ö–û–ú–ü–û–ù–ï–ù–¢ –ù–ê–°–¢–†–û–ï–ö (/settings)
        // =========================================================================
        const SettingsPage = () => {
            const [giftLibrary, setGiftLibrary] = useState([]);
            const [rounds, setRounds] = useState(DEFAULT_ROUNDS);
            const [selectedCountries, setSelectedCountries] = useState(DEFAULT_COUNTRIES);
            const [countryGifts, setCountryGifts] = useState({});
            const [loading, setLoading] = useState(true);
            const [savedStatus, setSavedStatus] = useState(false);
            const socketRef = useRef(null);

            useEffect(() => {
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–æ–∫–µ—Ç—É –¥–ª—è –ø—Ä–∏–µ–º–∞/–æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                if (typeof io !== 'undefined') {
                    socketRef.current = io();
                    
                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—à–ª–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø—Ä–∏–º–µ–Ω–∏–º –∏—Ö
                    socketRef.current.on('update-settings', (serverSettings) => {
                        if (serverSettings && serverSettings.countries) {
                            setRounds(serverSettings.rounds || DEFAULT_ROUNDS);
                            setSelectedCountries(serverSettings.countries);
                            setCountryGifts(serverSettings.gifts || {});
                        }
                    });
                }

                // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ø–æ–¥–∞—Ä–∫–æ–≤
                const fetchGifts = async () => {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/gift_library?select=*`, {
                            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                        });
                        const data = await response.json();
                        setGiftLibrary(data || []);
                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Supabase", error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchGifts();

                // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—Ä–æ–±—É–µ–º –ø–æ–¥—Ç—è–Ω—É—Ç—å –∏–∑ localStorage
                const saved = localStorage.getItem('tiktok_battle_settings');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.rounds) setRounds(parsed.rounds);
                        if (parsed.countries) setSelectedCountries(parsed.countries);
                        if (parsed.gifts) setCountryGifts(parsed.gifts);
                    } catch(e) { console.error(e); }
                }

                return () => { if (socketRef.current) socketRef.current.disconnect(); };
            }, []);

            const handleCountryChange = (index, countryId) => {
                const newCountries = [...selectedCountries];
                const countryObj = ALL_AVAILABLE_COUNTRIES.find(c => c.id === countryId);
                newCountries[index] = countryObj;
                setSelectedCountries(newCountries);
            };

            const handleGiftChange = (countryId, slotIndex, giftId) => {
                const newGifts = { ...countryGifts };
                if (!newGifts[countryId]) newGifts[countryId] = [null, null, null, null];
                const giftObj = giftLibrary.find(g => g.id.toString() === giftId.toString());
                newGifts[countryId][slotIndex] = giftObj;
                setCountryGifts(newGifts);
            };

            const handleSave = () => {
                const settingsToSave = {
                    rounds,
                    countries: selectedCountries,
                    gifts: countryGifts
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                localStorage.setItem('tiktok_battle_settings', JSON.stringify(settingsToSave));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –≤–∏–¥–∂–µ—Ç –≤ OBS —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏–ª—Å—è
                if (socketRef.current) {
                    socketRef.current.emit('save-settings', settingsToSave);
                }

                setSavedStatus(true);
                setTimeout(() => setSavedStatus(false), 3000);
            };

            if (loading) return <div className="text-white p-10 h-screen settings-bg">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –ø–æ–¥–∞—Ä–∫–æ–≤...</div>;

            return (
                <div className="text-white p-8 h-screen w-full settings-bg font-sans">
                    <div className="max-w-4xl mx-auto bg-slate-800 rounded-2xl p-6 shadow-2xl border border-slate-700">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
                            </h1>
                            <button onClick={() => window.location.href = '/'} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">
                                –ö –≤–∏–¥–∂–µ—Ç—É
                            </button>
                        </div>

                        <div className="mb-8 bg-slate-900 p-4 rounded-xl border border-slate-700">
                            <label className="block text-sm font-bold mb-2 text-cyan-400 uppercase tracking-wider">–í—Å–µ–≥–æ —Ä–∞—É–Ω–¥–æ–≤ –≤ –∏–≥—Ä–µ</label>
                            <input 
                                type="number" 
                                value={rounds} 
                                onChange={(e) => setRounds(e.target.value)} 
                                className="w-32 bg-slate-800 border border-slate-600 rounded p-2 text-white"
                                min="1" max="100"
                            />
                        </div>

                        <h2 className="text-xl font-bold mb-4 text-cyan-400 border-b border-slate-700 pb-2">–£—á–∞—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞–Ω—ã –∏ –ø–æ–¥–∞—Ä–∫–∏</h2>
                        
                        <div className="space-y-4">
                            {selectedCountries.map((sc, index) => (
                                <div key={index} className="bg-slate-900 p-4 rounded-xl border border-slate-700">
                                    <div className="flex items-center gap-4 mb-3">
                                        <span className="font-bold text-gray-400 w-6">{index + 1}.</span>
                                        <select 
                                            value={sc?.id || ''} 
                                            onChange={(e) => handleCountryChange(index, e.target.value)}
                                            className="bg-slate-800 border border-slate-600 rounded p-2 text-white font-bold min-w-[200px]"
                                        >
                                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É --</option>
                                            {ALL_AVAILABLE_COUNTRIES.map(c => (
                                                <option key={c.id} value={c.id}>{c.name}</option>
                                            ))}
                                        </select>
                                        {sc?.id && <img src={`https://flagcdn.com/w80/${sc.id}.png`} className="w-8 h-5 rounded-sm" />}
                                    </div>

                                    {sc?.id && (
                                        <div className="grid grid-cols-4 gap-3 pl-10">
                                            {[0, 1, 2, 3].map(slot => {
                                                const currentGift = countryGifts[sc.id]?.[slot];
                                                return (
                                                    <div key={slot} className="flex flex-col gap-1">
                                                        <label className="text-[10px] text-gray-500 uppercase">–ü–æ–¥–∞—Ä–æ–∫ {slot + 1}</label>
                                                        <select 
                                                            value={currentGift?.id || ''}
                                                            onChange={(e) => handleGiftChange(sc.id, slot, e.target.value)}
                                                            className="bg-slate-800 border border-slate-600 rounded p-1.5 text-xs text-white"
                                                        >
                                                            <option value="">- –ù–µ –≤—ã–±—Ä–∞–Ω -</option>
                                                            {giftLibrary.map(g => (
                                                                <option key={g.id} value={g.id}>{g.name} ({g.cost} –º–æ–Ω–µ—Ç)</option>
                                                            ))}
                                                        </select>
                                                        {currentGift && (
                                                            <div className="flex items-center gap-2 mt-1 bg-slate-800 p-1 rounded">
                                                                {currentGift.icon?.startsWith('http') ? 
                                                                    <img src={currentGift.icon} className="w-6 h-6 object-contain" /> : 
                                                                    <span>{currentGift.icon}</span>
                                                                }
                                                                <span className="text-xs text-yellow-400 font-bold">{currentGift.cost}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div className="mt-8 flex items-center gap-4 border-t border-slate-700 pt-6 pb-10">
                            <button 
                                onClick={handleSave}
                                className="px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105"
                            >
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                            </button>
                            {savedStatus && <span className="text-green-400 font-bold animate-pulse">–í–∏–¥–∂–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω! ‚úîÔ∏è</span>}
                        </div>
                    </div>
                </div>
            );
        };

        // =========================================================================
        // 2. –ì–õ–ê–í–ù–´–ô –í–ò–î–ñ–ï–¢ (–ò–ì–†–ê)
        // =========================================================================
        const WidgetApp = () => {
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è –Ω–∞ –ª–µ—Ç—É)
            const [appSettings, setAppSettings] = useState(() => {
                const saved = localStorage.getItem('tiktok_battle_settings');
                return saved ? JSON.parse(saved) : { rounds: DEFAULT_ROUNDS, countries: DEFAULT_COUNTRIES, gifts: {} };
            });

            const ACTIVE_COUNTRIES = appSettings.countries && appSettings.countries.length === 6 ? appSettings.countries : DEFAULT_COUNTRIES;
            const TOTAL_ROUNDS = appSettings.rounds || DEFAULT_ROUNDS;
            const ASSIGNED_GIFTS = appSettings.gifts || {};

            const [scores, setScores] = useState({});
            const [wins, setWins] = useState({});
            const [activeCountries, setActiveCountries] = useState(ACTIVE_COUNTRIES.map(c => c.id));
            const [round, setRound] = useState(1);
            
            const [phase, setPhase] = useState('PLAYING'); 
            const [timeLeft, setTimeLeft] = useState(ROUND_PLAY_SECONDS);
            const [eliminatedJustNow, setEliminatedJustNow] = useState(null); 
            
            const [pulsingIds, setPulsingIds] = useState(new Set());
            const [isDemoActive, setIsDemoActive] = useState(false); 

            // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –°–¢–ê–†–¢–ï ---
            useEffect(() => {
                if (activeCountries.length === ACTIVE_COUNTRIES.length && Object.keys(scores).length === 0) {
                    const initialScores = {};
                    ACTIVE_COUNTRIES.forEach(c => initialScores[c.id] = 0);
                    setScores(initialScores);
                    const initialWins = {};
                    ACTIVE_COUNTRIES.forEach(c => initialWins[c.id] = 0);
                    setWins(initialWins);
                }
            }, []);

            // --- Refs –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ Socket.io ---
            const phaseRef = useRef(phase);
            const activeCountriesRef = useRef(activeCountries);
            const assignedGiftsRef = useRef(ASSIGNED_GIFTS);
            
            useEffect(() => { phaseRef.current = phase; }, [phase]);
            useEffect(() => { activeCountriesRef.current = activeCountries; }, [activeCountries]);
            useEffect(() => { assignedGiftsRef.current = ASSIGNED_GIFTS; }, [ASSIGNED_GIFTS]);

            // --- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£ –ß–ï–†–ï–ó SOCKET.IO ---
            useEffect(() => {
                const socket = typeof io !== 'undefined' ? io() : null;
                if (socket) {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞ –∏–∑ —ç—Ñ–∏—Ä–∞
                    socket.on('tiktok-gift', (data) => {
                        let targetCountryId = null;
                        let giftValue = 0;

                        Object.entries(assignedGiftsRef.current).forEach(([countryId, giftsArray]) => {
                            if (!giftsArray) return;
                            const matchedGift = giftsArray.find(g => g && g.name.toLowerCase() === data.giftName.toLowerCase());
                            if (matchedGift) {
                                targetCountryId = countryId;
                                giftValue = matchedGift.cost;
                            }
                        });

                        if (targetCountryId && giftValue > 0) {
                            if (!activeCountriesRef.current.includes(targetCountryId) || phaseRef.current !== 'PLAYING') return;

                            setScores(prev => ({ ...prev, [targetCountryId]: (prev[targetCountryId] || 0) + giftValue }));

                            setPulsingIds(prev => new Set(prev).add(targetCountryId));
                            setTimeout(() => {
                                setPulsingIds(prev => {
                                    const newSet = new Set(prev);
                                    newSet.delete(targetCountryId);
                                    return newSet;
                                });
                            }, 400);
                        }
                    });

                    // –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ò –°–û–•–†–ê–ù–ï–ù–ò–ò –ù–ê–°–¢–†–û–ï–ö
                    socket.on('update-settings', (newSettings) => {
                        if (newSettings && newSettings.countries) {
                            setAppSettings(newSettings);
                            localStorage.setItem('tiktok_battle_settings', JSON.stringify(newSettings));
                            
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É –ø–æ–¥ –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            const newCountriesList = newSettings.countries.length === 6 ? newSettings.countries : DEFAULT_COUNTRIES;
                            setActiveCountries(newCountriesList.map(c => c.id));
                            
                            const initialScores = {};
                            newCountriesList.forEach(c => initialScores[c.id] = 0);
                            setScores(initialScores);
                            
                            const initialWins = {};
                            newCountriesList.forEach(c => initialWins[c.id] = 0);
                            setWins(initialWins);
                            
                            setRound(1);
                            setPhase('PLAYING');
                            setTimeLeft(ROUND_PLAY_SECONDS);
                            setEliminatedJustNow(null);
                        }
                    });

                    return () => socket.disconnect();
                }
            }, []);

            // --- –ú–ê–®–ò–ù–ê –°–û–°–¢–û–Ø–ù–ò–ô (–¢–ê–ô–ú–ï–† –ò–ì–†–´) ---
            useEffect(() => {
                if (phase === 'GAME_OVER') return;
                const timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                return () => clearInterval(timer);
            }, [phase]);

            // --- –õ–û–ì–ò–ö–ê –§–ê–ó ---
            useEffect(() => {
                if (timeLeft <= 0) {
                    if (phase === 'PLAYING') {
                        let minScore = Infinity;
                        let lowestId = null;
                        activeCountries.forEach(id => {
                            const s = scores[id] || 0;
                            if (s < minScore) { minScore = s; lowestId = id; }
                        });
                        setEliminatedJustNow(lowestId);
                        setPhase('ELIMINATING');
                        setTimeLeft(ROUND_ELIM_SECONDS);
                    } 
                    else if (phase === 'ELIMINATING') {
                        const newActive = activeCountries.filter(id => id !== eliminatedJustNow);
                        setActiveCountries(newActive);
                        setEliminatedJustNow(null);
                        
                        if (newActive.length === 1) {
                            setPhase('CELEBRATING');
                            setWins(w => ({ ...w, [newActive[0]]: (w[newActive[0]] || 0) + 1 }));
                            setTimeLeft(ROUND_CELEB_SECONDS);
                        } else {
                            setPhase('PAUSED');
                            setTimeLeft(ROUND_PAUSE_SECONDS);
                        }
                    }
                    else if (phase === 'PAUSED') {
                        setPhase('PLAYING');
                        setTimeLeft(ROUND_PLAY_SECONDS);
                    }
                    else if (phase === 'CELEBRATING') {
                        if (round < TOTAL_ROUNDS) {
                            setPhase('ROUND_BREAK');
                            setTimeLeft(ROUND_BREAK_SECONDS);
                        } else {
                            setPhase('GAME_OVER');
                        }
                    }
                    else if (phase === 'ROUND_BREAK') {
                        setRound(r => r + 1);
                        setActiveCountries(ACTIVE_COUNTRIES.map(c => c.id));
                        const resetScores = {};
                        ACTIVE_COUNTRIES.forEach(c => resetScores[c.id] = 0);
                        setScores(resetScores);
                        setPhase('PLAYING');
                        setTimeLeft(ROUND_PLAY_SECONDS);
                    }
                }
            }, [timeLeft, phase, activeCountries, scores, eliminatedJustNow, round, ACTIVE_COUNTRIES, TOTAL_ROUNDS]);

            // --- –°–ò–ú–£–õ–Ø–¢–û–† –î–û–ù–ê–¢–û–í (–ö–ù–û–ü–ö–ê DEMO) ---
            useEffect(() => {
                if (!isDemoActive || phase !== 'PLAYING') return;

                const interval = setInterval(() => {
                    if (activeCountries.length === 0) return;
                    
                    const randomCountryId = activeCountries[Math.floor(Math.random() * activeCountries.length)];
                    const countryAvailGifts = ASSIGNED_GIFTS[randomCountryId];
                    if (!countryAvailGifts || countryAvailGifts.length === 0) return;
                    
                    const validGifts = countryAvailGifts.filter(g => g !== null);
                    if (validGifts.length === 0) return;

                    const rand = Math.random();
                    let giftIdx = 0;
                    if (rand > 0.6 && rand <= 0.9) giftIdx = Math.min(1, validGifts.length - 1);
                    else if (rand > 0.9 && rand <= 0.98) giftIdx = Math.min(2, validGifts.length - 1);
                    else if (rand > 0.98) giftIdx = Math.min(3, validGifts.length - 1);

                    const gift = validGifts[giftIdx];
                    if (!gift) return;

                    setScores(prev => ({ ...prev, [randomCountryId]: (prev[randomCountryId] || 0) + gift.cost }));
                    setPulsingIds(prev => new Set(prev).add(randomCountryId));
                    setTimeout(() => {
                        setPulsingIds(prev => {
                            const newSet = new Set(prev);
                            newSet.delete(randomCountryId);
                            return newSet;
                        });
                    }, 400);

                }, Math.random() * 800 + 400);

                return () => clearInterval(interval);
            }, [isDemoActive, phase, activeCountries, ASSIGNED_GIFTS]);

            // --- –°–û–†–¢–ò–†–û–í–ö–ê –î–õ–Ø –õ–ò–î–ï–†–ë–û–†–î–ê ---
            const sortedCountriesWithEliminating = useMemo(() => {
                const listToRender = phase === 'ELIMINATING' && eliminatedJustNow && !activeCountries.includes(eliminatedJustNow)
                    ? [...activeCountries, eliminatedJustNow] 
                    : activeCountries;

                return listToRender
                    .map(id => ({ ...ACTIVE_COUNTRIES.find(c => c.id === id), score: scores[id] || 0 }))
                    .sort((a, b) => b.score - a.score);
            }, [activeCountries, scores, phase, eliminatedJustNow, ACTIVE_COUNTRIES]);

            const maxScore = sortedCountriesWithEliminating[0]?.score || 1;
            const roundWinner = phase === 'CELEBRATING' ? ACTIVE_COUNTRIES.find(c => c.id === activeCountries[0]) : null;

            return (
                <div className="w-full h-screen demo-background flex flex-col items-center overflow-hidden text-white font-sans relative">
                    
                    <button 
                        onClick={() => setIsDemoActive(!isDemoActive)} 
                        className={`absolute top-4 right-4 z-50 text-[10px] px-2.5 py-1 rounded-full border ${isDemoActive ? 'border-green-500 text-green-400 bg-green-500/10' : 'border-gray-500 text-gray-400 bg-gray-500/10'} cursor-pointer hover:bg-white/10 transition-colors backdrop-blur-sm shadow-lg`}
                    >
                        {isDemoActive ? 'Demo ON' : 'Demo OFF'}
                    </button>

                    {/* --- –¢–ê–ë–õ–ò–¶–ê –ü–û–ë–ï–î (22% –í–´–°–û–¢–´) --- */}
                    <div className="w-full shrink-0 h-[22%] min-h-[160px] flex flex-col items-center justify-center p-3 pt-4 z-10 relative">
                        <div className="absolute inset-0 bg-gradient-to-b from-yellow-500/10 to-transparent pointer-events-none"></div>
                        
                        <h3 className="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-yellow-500 to-yellow-300 uppercase tracking-[0.2em] drop-shadow-md mb-3 flex items-center gap-2">
                            <span className="text-2xl">üèÜ</span> –¢–∞–±–ª–∏—Ü–∞ –ø–æ–±–µ–¥ <span className="text-2xl">üèÜ</span>
                        </h3>
                        
                        <div className="grid grid-cols-3 gap-3 w-full max-w-[460px]">
                            {ACTIVE_COUNTRIES.map(c => (
                                <div key={c.id} className="bg-black/50 border border-white/10 rounded-xl p-3 flex items-center backdrop-blur-xl shadow-[0_4px_15px_rgba(0,0,0,0.5)] transition-transform hover:scale-105">
                                    <img src={`https://flagcdn.com/w80/${c.id}.png`} className="w-10 h-7 rounded-sm shadow-sm mr-3 border border-white/10 object-cover" alt={c.name} />
                                    <div className="flex flex-col justify-center">
                                        <span className="text-xs text-gray-400 uppercase tracking-widest leading-none mb-1.5 truncate max-w-[70px]">{c.name}</span>
                                        <div className="flex items-end gap-1 leading-none">
                                            <span className="text-3xl font-black text-green-400 drop-shadow-[0_0_8px_rgba(0,255,136,0.4)] leading-none">{wins[c.id] || 0}</span>
                                            <span className="text-[10px] text-gray-500 uppercase tracking-wider mb-1">–ø–æ–±–µ–¥</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* --- –¢–ê–ô–ú–ï–† –ò –§–ê–ó–ê (10% –í–´–°–û–¢–´) --- */}
                    <div className="w-full shrink-0 h-[10%] min-h-[80px] flex flex-col items-center justify-center z-20 relative">
                        <div className="flex items-center gap-5">
                            <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-yellow-500 uppercase tracking-widest drop-shadow-[0_0_10px_rgba(255,105,180,0.5)]">
                                –†–∞—É–Ω–¥ {round}/{TOTAL_ROUNDS}
                            </div>
                            
                            <div className={`text-5xl font-black font-mono drop-shadow-[0_0_15px_rgba(0,0,0,0.8)] transition-colors duration-300
                                ${(phase === 'ELIMINATING' || phase === 'PAUSED') ? 'text-red-500 animate-pulse' : 
                                  (phase === 'PLAYING' && timeLeft <= 10) ? 'text-red-400 animate-pulse' : 'text-cyan-400'}`}>
                                {formatTime(timeLeft)}
                            </div>
                        </div>
                        
                        <div className="text-sm text-gray-400 uppercase tracking-widest mt-2 text-center">
                            {phase === 'PLAYING' ? '–î–æ –≤—ã–±—ã–≤–∞–Ω–∏—è' : 
                             phase === 'ELIMINATING' ? '–í—ã–±—ã–≤–∞–Ω–∏–µ...' : 
                             phase === 'PAUSED' ? '–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑' : 
                             phase === 'CELEBRATING' ? '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å!' : 
                             phase === 'ROUND_BREAK' ? '–ü–µ—Ä–µ—Ä—ã–≤' : '–ö–æ–Ω–µ—Ü –∏–≥—Ä—ã'}
                        </div>
                    </div>

                    {/* --- –ê–î–ê–ü–¢–ò–í–ù–´–ô –†–ï–ô–¢–ò–ù–ì –ù–ê –í–°–Æ –®–ò–†–ò–ù–£ --- */}
                    <div className="w-full flex-1 relative px-2 z-10 flex flex-col justify-center items-center min-h-[100px]">
                        
                        {phase === 'CELEBRATING' && roundWinner && (
                            <div className="absolute inset-0 z-50 flex items-center justify-center winner-anim">
                                <div className="bg-gradient-to-br from-yellow-500 via-orange-500 to-red-500 p-0.5 rounded-3xl shadow-[0_0_80px_rgba(255,165,0,0.8)]">
                                    <div className="bg-black/95 rounded-[22px] px-8 py-6 text-center backdrop-blur-xl flex flex-col items-center border border-yellow-500/30">
                                        <img src={`https://flagcdn.com/w80/${roundWinner.id}.png`} className="w-20 h-auto rounded-md drop-shadow-2xl mb-3 border border-white/20" alt="winner" />
                                        <h2 className="text-2xl font-black text-white uppercase tracking-wider mb-1">–ü–û–ë–ï–î–ò–¢–ï–õ–¨ –†–ê–£–ù–î–ê!</h2>
                                        <h3 className="text-lg text-yellow-400 font-bold">+1 –≤ –∫–æ–ø–∏–ª–∫—É</h3>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="relative w-full" style={{ 
                            height: `${sortedCountriesWithEliminating.reduce((sum, _, i) => sum + (RANK_SIZES[i]?.h || 30) + LIST_GAP, 0)}px` 
                        }}>
                            {sortedCountriesWithEliminating.map((country, index) => {
                                const rankConfig = RANK_SIZES[index] || RANK_SIZES[RANK_SIZES.length - 1];
                                
                                let translateY = 0;
                                for (let i = 0; i < index; i++) translateY += (RANK_SIZES[i]?.h || 30) + LIST_GAP;

                                const isLastInPlaying = index === sortedCountriesWithEliminating.length - 1 && phase === 'PLAYING';
                                const isDanger = isLastInPlaying && timeLeft <= 10;
                                const isEliminatingNow = phase === 'ELIMINATING' && country.id === eliminatedJustNow;
                                const isPulsing = pulsingIds.has(country.id);
                                const progressPercentage = Math.max(2, (country.score / maxScore) * 100);

                                return (
                                    <div 
                                        key={country.id}
                                        className={`absolute left-0 right-0 rounded-2xl flex items-center overflow-hidden border transition-all duration-500 ease-in-out
                                            ${rankConfig.bg} ${rankConfig.pad}
                                            ${isDanger ? 'border-red-500/80 shadow-[0_0_20px_rgba(255,0,0,0.6)] animate-pulse bg-red-950/40' : rankConfig.border}
                                            ${isEliminatingNow ? 'eliminating-anim z-50' : 'z-20'}
                                        `}
                                        style={{ 
                                            transform: `translateY(${translateY}px)`, 
                                            height: `${rankConfig.h}px`,
                                            zIndex: 20 - index
                                        }}
                                    >
                                        <img src={`https://flagcdn.com/w80/${country.id}.png`} className={`${rankConfig.flag} rounded-sm object-cover mr-3 drop-shadow-md border border-white/10`} alt={country.name} />
                                        <div className={`font-bold text-white flex-1 ${rankConfig.font} truncate`}>{country.name}</div>
                                        <div className="flex flex-col items-end z-10 ml-2">
                                            <span className={`font-black tabular-nums ${rankConfig.scoreFont} ${isPulsing ? 'score-pulse' : ''} ${isDanger ? 'text-white' : 'text-green-400'}`}>
                                                {country.score.toLocaleString('ru-RU')}
                                            </span>
                                        </div>
                                        <div className="absolute top-0 left-0 h-full rounded-2xl overflow-hidden opacity-30 pointer-events-none w-full">
                                            <div className="h-full progress-bar-transition bg-gradient-to-r from-green-500 to-cyan-500" style={{ width: `${progressPercentage}%` }}></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* --- –°–ï–¢–ö–ê –ü–û–î–ê–†–ö–û–í –í–ù–ò–ó–£ (38% –í–´–°–û–¢–´) --- */}
                    <div className="w-full shrink-0 h-[38%] bg-black/95 border-t border-white/10 p-2 pb-10 z-30 flex flex-col backdrop-blur-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.9)]">
                        <div className="text-center text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-1.5 mt-0.5">
                            ‚¨áÔ∏è –ü–æ–¥–∞—Ä–∫–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å—Ç—Ä–∞–Ω ‚¨áÔ∏è
                        </div>
                        <div className="grid grid-cols-3 grid-rows-2 gap-2 h-full pb-1">
                            {ACTIVE_COUNTRIES.map(country => {
                                const isActive = activeCountries.includes(country.id);
                                const isEliminatingNow = phase === 'ELIMINATING' && country.id === eliminatedJustNow;
                                const effectivelyActive = isActive || isEliminatingNow;
                                const gifts = ASSIGNED_GIFTS[country.id] || [];

                                return (
                                    <div key={country.id} className={`flex flex-col rounded-xl border ${effectivelyActive ? 'bg-white/5 border-white/10' : 'bg-black border-red-900/50 opacity-30 grayscale'} overflow-hidden relative transition-all duration-500`}>
                                        
                                        <div className="bg-white/10 py-1.5 flex items-center justify-center gap-2 border-b border-white/5 shrink-0">
                                            <img src={`https://flagcdn.com/w80/${country.id}.png`} className="w-5 h-3.5 rounded-sm object-cover drop-shadow-sm border border-white/20" alt={country.name} />
                                            <span className="text-[11px] font-bold text-white truncate max-w-[80px] uppercase tracking-wider">{country.name}</span>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 grid-rows-2 flex-1 p-1 gap-1">
                                            {[0, 1, 2, 3].map((slotIdx) => {
                                                const gift = gifts[slotIdx];
                                                return (
                                                    <div key={slotIdx} className="bg-black/60 rounded-lg flex flex-col items-center justify-center relative overflow-hidden group">
                                                        {gift ? (
                                                            <>
                                                                {gift.icon && gift.icon.startsWith('http') ? (
                                                                    <img src={gift.icon} className="w-12 h-12 object-contain mb-1 drop-shadow-[0_0_8px_rgba(255,255,255,0.4)]" alt={gift.name} />
                                                                ) : (
                                                                    <span className="text-4xl mb-1 drop-shadow-[0_0_8px_rgba(255,255,255,0.4)]">{gift.icon}</span>
                                                                )}
                                                                <div className="flex items-center text-[11px] font-black text-yellow-400 bg-black/80 px-2.5 py-0.5 rounded-full border border-yellow-500/30">
                                                                    {gift.cost}
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <span className="text-[9px] text-gray-600 uppercase font-bold text-center leading-tight">–ü—É—Å—Ç–æ</span>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {!effectivelyActive && (
                                            <div className="absolute inset-0 bg-red-900/50 flex items-center justify-center backdrop-blur-[2px] z-10">
                                                <span className="text-red-500 font-black uppercase text-base rotate-[-15deg] border-2 border-red-500 px-2 py-0.5 rounded bg-black/80 shadow-[0_0_10px_rgba(255,0,0,0.5)]">–í–´–ë–´–õ</span>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* --- –ü–ï–†–ï–†–´–í –ú–ï–ñ–î–£ –†–ê–£–ù–î–ê–ú–ò --- */}
                    {phase === 'ROUND_BREAK' && (
                        <div className="absolute inset-0 z-[100] bg-black/95 backdrop-blur-3xl flex flex-col items-center justify-center p-6 text-center winner-anim">
                            <div className="w-24 h-24 mb-6 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                            <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 uppercase tracking-widest mb-4">
                                –ü–µ—Ä–µ—Ä—ã–≤ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏
                            </h2>
                            <div className="text-[120px] leading-none font-black font-mono text-white drop-shadow-[0_0_40px_rgba(255,255,255,0.6)] mb-6">
                                {formatTime(timeLeft)}
                            </div>
                            <div className="text-lg text-gray-400 uppercase tracking-widest mt-4 bg-white/10 px-6 py-2 rounded-full border border-white/5">
                                –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –ø–æ–¥–∞—Ä–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞!
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        // =========================================================================
        // 3. –†–û–£–¢–ï–† –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö
        // =========================================================================
        const MainApp = () => {
            const [path, setPath] = useState(window.location.pathname + window.location.hash);

            useEffect(() => {
                const onLocationChange = () => setPath(window.location.pathname + window.location.hash);
                window.addEventListener('popstate', onLocationChange);
                window.addEventListener('hashchange', onLocationChange);
                return () => {
                    window.removeEventListener('popstate', onLocationChange);
                    window.removeEventListener('hashchange', onLocationChange);
                };
            }, []);

            if (path.includes('/settings')) {
                return <SettingsPage />;
            }

            return <WidgetApp />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
